//get all buttons, input, and displays
const adN = document.getElementById("adN");
const payMeN = document.getElementById("payMeN");
const adScreenN = document.getElementById("adScreenN");
const ourButtons = document.getElementById("ourButtons");
const warning3 = document.getElementById("available-email");
const emailButton = document.getElementById("registerEmail");
const hideThis = document.getElementById("hideThis");

hideThis.style.display = "none";//hide the email textbox
emailButton.addEventListener("click", addEmail);

let claimCoins; //button that does not yet exist

async function back(event) {//return to lobby
  event.preventDefault();
  document.location.replace("/dashboard");
}

//display email controls and hide other options
function enterEmail() {
  hideThis.style.display = "block";
  ourButtons.style.display = "none";
}
//email entry function
async function addEmail() {
  const email = document.querySelector("#new-email").value;//get email

  const addIt = await fetch("/API/user/email", {//make api call with email
    method: "PUT",
    body: JSON.stringify({
      email,
    }),
    headers: {
      "Content-Type": "application/json",
    },
  });

  if (addIt.ok) {//display a message directing to check email
    
    warning3.style.color = "navy";
    warning3.innerText =
      "You should receive an email shortly, check the junk folder.";
    setTimeout(() => {
      document.location.replace("/dashboard");//after user has had time to read the message, return to lobby
    }, 4000);
  } else {
    console.log("email fail");
  }
}

//play video
async function playVid() {
  //display video and hide other options
  adScreenN.style.display = "block";
  ourButtons.style.display = "none";

  
  //display placeholder (yet relevant) video, in future this could be an ad 
  adN.innerHTML = `<iframe id="video1" src= 'https://www.youtube.com/embed/P2oXbAKUm1w?&autoplay=1&mute=1&controls=0' frameborder='0'  ></iframe>`;

  const coins1 = await fetch("/API/free/coins1", {//api call to notify server that watching has begun
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      "Content-Length": "0",
    },
  });
  if (coins1.ok) {//the response is delayed by the server for almost the playing time of the video
    coins1.json().then((data) => {
      //display and enable button including unique code generated by this api call
      payMeN.innerHTML = `<button type="button" id="claimCoins" value="${data.coupon}">Click To Get Coins!</button>`;
      claimCoins = document.getElementById("claimCoins");
      claimCoins.addEventListener("click", getCoins);
    });
  } else {
    console.log("Houston we have a problemerino555");
  }
}

//claim coins
async function getCoins(e) {
  claimCoins.removeEventListener("click", getCoins); //disable button
  let v = e.target.value;//get code generated when watching started

  const coins2 = await fetch("/API/free/coins2", {//send code to server
    method: "PUT",
    body: JSON.stringify({
      v,
    }),
    headers: {
      "Content-Type": "application/json",
    },
  });
  if (coins2.ok) {//if the code matches the one generated, then add the coins and notify user
    coins2.json().then((data) => {
      console.log(data);
      //could display a message instead of directly returning, but for a small amount of coins and after the ordeal of watching the video
      //it is maybe more polite to send them straight back to the games 
      document.location.replace("/dashboard");
    });
  } else {
    console.log("Houston we have a problemerino5556");
  }
}

//verify that this email has not been used before and is actually an email address, triggered at each keystroke
async function verifyEmail() {
  let emailAddy = document.getElementById("new-email").value;//get email
  let p;

  if (emailAddy == "") {//if empty display default message
    warning3.style.color = "black";
    warning3.innerText = "Enter your email address";
    p = false; //hide button
  } else {
    const check = emailAddy.match(//if not an email at all display warning
      /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/
    );
    if (!check) {
      warning3.style.color = "orange";
      warning3.innerText = "Enter a valid email address";
      p = false; //hide button
    } else {
      const BB = await fetch(`/API/user/checkE/${emailAddy}`, {//else check if already been used
        method: "GET",
        headers: {
          "Content-Type": "application/json",
        },
      });

      if (BB.status == 200) {//status 200 indicates that the database does not contain this email
        console.log("200");
        warning3.style.color = "green";
        warning3.innerText = "Nice email address!";
        p = true; //display button
      } else {               //status 298 indicates otherwise
        //status == 298
        console.log("298");
        warning3.style.color = "red";
        warning3.innerText = "This address has already been used.";
        p = false; //hide button
      }
    }
  }
  if (p) emailButton.style.visibility = "visible";//if email is ok, display button
  else emailButton.style.visibility = "hidden";
  return;
}

document.querySelector("#backToLobby2").addEventListener("click", back);
document.querySelector("#playVideoN").addEventListener("click", playVid);
document.querySelector("#new-email").addEventListener("input", verifyEmail);
document.querySelector("#registerN").addEventListener("click", enterEmail);

// ******************** For background Image Change**************************//
function handleBG() {
  

  const castle = document.querySelector("#castle");//removecastle
  castle.removeAttribute("class", "bannerC");

  const body = document.querySelector("body");
  body.removeAttribute("class", "bannerA");//remove gray 
  body.setAttribute("class", "bannerB");//add chips and dice
}

handleBG();
